require('dotenv').config();
const express = require('express');
const session = require('express-session');
const bcrypt = require('bcrypt');
const bodyParser = require('body-parser');
const multer = require('multer');
const fs = require('fs');
const path = require('path');
const { Pool } = require('pg');
const AWS = require('aws-sdk');
const multerS3 = require('multer-s3');

const app = express();
const PORT = process.env.PORT || 3000;

const db = new Pool({ connectionString: process.env.DATABASE_URL, ssl: { rejectUnauthorized: false } });

const s3 = new AWS.S3({
  accessKeyId: process.env.AWS_ACCESS_KEY_ID,
  secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY
});

app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());
app.use(express.static('public'));
app.use(session({
  secret: process.env.SESSION_SECRET || 'supersecretkey',
  resave: false,
  saveUninitialized: false
}));

const upload = multer({
  storage: multerS3({
    s3: s3,
    bucket: process.env.AWS_BUCKET_NAME,
    acl: 'public-read',
    key: (req, file, cb) => cb(null, Date.now() + '-' + file.originalname)
  })
});

// Initialize tables
(async () => {
  await db.query(`
    CREATE TABLE IF NOT EXISTS staff (
      id SERIAL PRIMARY KEY,
      username TEXT UNIQUE,
      password TEXT,
      role TEXT
    );
    CREATE TABLE IF NOT EXISTS submissions (
      id SERIAL PRIMARY KEY,
      name TEXT,
      financials TEXT,
      otherInfo TEXT,
      filePath TEXT,
      date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );
  `);

  const hash = await bcrypt.hash('password123', 10);
  await db.query(`INSERT INTO staff (username,password,role) VALUES ('admin','$1','admin') ON CONFLICT (username) DO NOTHING`, [hash]);
})();

function requireLogin(req, res, next) {
  if (!req.session.userId) return res.status(401).send('Unauthorized');
  next();
}

app.post('/login', async (req, res) => {
  const { username, password } = req.body;
  const user = (await db.query('SELECT * FROM staff WHERE username=$1', [username])).rows[0];
  if (!user || !(await bcrypt.compare(password, user.password))) return res.status(400).json({ error: 'Invalid credentials' });
  req.session.userId = user.id;
  req.session.role = user.role;
  res.json({ message: 'Login successful' });
});

app.post('/logout', (req, res) => {
  req.session.destroy();
  res.json({ message: 'Logged out' });
});

app.post('/submit', upload.single('file'), async (req, res) => {
  const { name, financials, otherInfo } = req.body;
  const filePath = req.file ? req.file.location : null;
  await db.query('INSERT INTO submissions (name, financials, otherInfo, filePath) VALUES ($1,$2,$3,$4)', [name, financials, otherInfo, filePath]);
  res.json({ message: 'Submission successful' });
});

app.get('/submissions', requireLogin, async (req, res) => {
  const rows = (await db.query('SELECT * FROM submissions ORDER BY date DESC')).rows;
  res.json(rows);
});

app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));
